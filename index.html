<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fashion Stocks Dashboard</title>
    <link rel="stylesheet" href="styling.css">
</head>
<body>

    <h1>Fashion Stocks Dashboard</h1>

    <h2>Instructions</h2>
    <p>Obtain an Alpha Vantage API Key and enter it when prompted.</p>
    <p>Enter a stock symbol (e.g., <strong>LVMUY</strong> for LVMH), then click Lookup.</p>

    <label>Stock Symbol:</label>
    <select id="input-symbol">
        <option value="LVMUY">LVMH (LVMUY)</option>
        <option value="CPRI">Capri Holdings (CPRI)</option>
        <option value="PPRUY">Kering (PPRUY)</option>
        <option value="RMS.PA">Hermes (RMS.PA)</option>
        <option value="CFRUY">Richemont (CFRUY)</option>
        <option value="TPR">Tapestry (TPR)</option>
        <option value="EL">Est√©e Lauder (EL)</option>
        <option value="RL">Ralph Lauren (RL)</option>
    </select>
    <button id="lookup">Lookup</button>

    <hr>
    <h2>Stock Information</h2>

    <div class="flex-container">
        <div id="display-stock-info">
            <p>Date: <span id="display-date">---</span></p>
            <p>Open: <span id="display-open">---</span></p>
            <p>High: <span id="display-high">---</span></p>
            <p>Low: <span id="display-low">---</span></p>
            <p>Close: <span id="display-close">---</span></p>
            <p>Volume: <span id="display-volume">---</span></p>
        </div>

        <div id="chart">
            <svg id="stock-graph" width="500" height="250"></svg>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script type="text/javascript">

        var apiKey = sessionStorage.getItem("ALPHAVANTAGE_API_KEY")
        if (!apiKey) {
            apiKey = prompt("Please enter your AlphaVantage API key:")
            sessionStorage.setItem("ALPHAVANTAGE_API_KEY", apiKey)
        }

        var inputSymbol = document.getElementById("input-symbol")
        var lookupButton = document.getElementById("lookup")

        var displayDate = document.getElementById("display-date")
        var displayOpen = document.getElementById("display-open")
        var displayHigh = document.getElementById("display-high")
        var displayLow = document.getElementById("display-low")
        var displayClose = document.getElementById("display-close")
        var displayVolume = document.getElementById("display-volume")

        // Fetching and displaying stock data
        function lookupStock() {
            var symbol = inputSymbol.value
            console.log("SYMBOL:", symbol)

            var requestUrl = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${apiKey}`
            d3.json(requestUrl).then(function(data) {
                console.log("RESPONSE:", data)

                if (!data["Time Series (Daily)"]) {
                    console.error("Invalid symbol or response")
                    alert("Invalid symbol or API error. Check console.")
                    return
                }

                var timeSeries = data["Time Series (Daily)"]
                var latestDate = Object.keys(timeSeries)[0]
                var stockData = timeSeries[latestDate]

                displayDate.innerText = latestDate
                displayOpen.innerText = stockData["1. open"]
                displayHigh.innerText = stockData["2. high"]
                displayLow.innerText = stockData["3. low"]
                displayClose.innerText = stockData["4. close"]
                displayVolume.innerText = stockData["5. volume"]

                var graphData = Object.keys(timeSeries).map(function(date) {
                    return {
                        date: new Date(date),
                        close: parseFloat(timeSeries[date]["4. close"])
                    };
                });

                renderChart(graphData);

            }).catch(function(error) {
                console.error("ERROR:", error)
            })
        }

        function renderChart(data) {
            var svg = d3.select("#stock-graph");
            var margin = { top: 20, right: 30, bottom: 60, left: 50 }; // increased bottom margin for x-axis label
            var width = +svg.attr("width") - margin.left - margin.right;
            var height = +svg.attr("height") - margin.top - margin.bottom;

            // Clear the existing chart elements before rendering new ones
            svg.selectAll("*").remove();

            var g = svg.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scaleTime()
                .domain(d3.extent(data, function(d) { return d.date; }))
                .range([0, width]);

            var y = d3.scaleLinear()
                .domain([0, d3.max(data, function(d) { return d.close; })])
                .range([height, 0]);

            // X-axis
            g.append("g")
                .selectAll(".x-axis")
                .data([data])
                .enter().append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x));

            // Y-axis
            g.append("g")
                .selectAll(".y-axis")
                .data([data])
                .enter().append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y));

            // X-axis label
            svg.append("text")
                .attr("transform", "translate(" + (width / 2 + margin.left) + " ," + (height + margin.top + 50) + ")")
                .style("text-anchor", "middle")
                .attr("fill", "#f8c8dc")
                .text("Date");

            // Y-axis label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", margin.left - 35)
                .attr("x", -(height / 2) - margin.top)
                .style("text-anchor", "middle")
                .attr("fill", "#f8c8dc")
                .text("Closing Price (USD)");

            // Line chart
            g.append("path")
                .datum(data)
                .attr("class", "line")
                .attr("fill", "none")
                .attr("stroke", "#f8c8dc")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(function(d) { return x(d.date); })
                    .y(function(d) { return y(d.close); })
                );
        }

        lookupButton.addEventListener("click", lookupStock, false)

    </script>

</body>
</html>
